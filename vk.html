<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Публикация в ВКонтакте</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800;900&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    :root {
      --primary: #8a2be2;
      --primary-dark: #4d00ff;
      --primary-light: #9d4edd;
      --accent: #ff006e;
      --accent-glow: rgba(255, 0, 110, 0.7);
      --neon-blue: #00f5ff;
      --neon-purple: #bc00ff;
      --dark-bg: #0a0a1a;
      --darker-bg: #050510;
      --card-bg: rgba(20, 10, 40, 0.85);
      --card-border: rgba(138, 43, 226, 0.3);
      --text-primary: #ffffff;
      --text-secondary: #e0e0e0;
      --text-glow: rgba(255, 255, 255, 0.8);
    }
    
    body {
      font-family: 'Montserrat', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: var(--text-primary);
      min-height: 100vh;
      background: 
        radial-gradient(circle at 20% 80%, rgba(77, 0, 255, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 0, 110, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(0, 245, 255, 0.1) 0%, transparent 50%),
        linear-gradient(135deg, var(--darker-bg) 0%, var(--dark-bg) 50%, var(--darker-bg) 100%);
      display: flex;
      flex-direction: column;
      position: relative;
      overflow-x: hidden;
    }
    
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        linear-gradient(90deg, transparent 98%, rgba(138, 43, 226, 0.03) 100%),
        linear-gradient(0deg, transparent 98%, rgba(138, 43, 226, 0.03) 100%);
      background-size: 30px 30px;
      pointer-events: none;
      z-index: 1;
    }
    
    /* Стили для частиц */
    .particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
    }
    
    .particle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: var(--primary);
      border-radius: 50%;
      box-shadow: 0 0 10px var(--primary), 0 0 20px var(--primary);
      animation: float 15s infinite linear;
    }
    
    @keyframes float {
      0% {
        transform: translateY(100vh) translateX(0);
        opacity: 0;
      }
      10% {
        opacity: 1;
      }
      90% {
        opacity: 1;
      }
      100% {
        transform: translateY(-100px) translateX(100px);
        opacity: 0;
      }
    }
    
    /* Навигационная панель */
    nav {
      background: rgba(10, 5, 25, 0.95);
      padding: 18px 20px;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      gap: 35px;
      flex-wrap: wrap;
      z-index: 10;
      position: relative;
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(138, 43, 226, 0.2);
    }
    
    nav a {
      color: var(--text-primary);
      text-decoration: none;
      font-weight: bold;
      font-size: 1.1rem;
      padding: 12px 24px;
      border-radius: 25px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      background: rgba(138, 43, 226, 0.1);
      border: 1px solid transparent;
      display: flex;
      align-items: center;
      gap: 10px;
      font-family: 'Montserrat', sans-serif;
    }
    
    nav a::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
      opacity: 0;
      transition: opacity 0.3s;
      z-index: -1;
      border-radius: 25px;
    }
    
    nav a:hover {
      color: white;
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(77, 0, 255, 0.4);
      border: 1px solid rgba(138, 43, 226, 0.5);
    }
    
    nav a:hover::before {
      opacity: 1;
    }
    
    nav a i {
      font-size: 1.2rem;
    }
    
    header {
      background: rgba(10, 5, 25, 0.95);
      padding: 25px;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.8);
      text-align: center;
      color: transparent;
      background-clip: text;
      -webkit-background-clip: text;
      background-image: linear-gradient(135deg, var(--primary) 0%, var(--neon-blue) 50%, var(--accent) 100%);
      font-size: 2.5rem;
      font-weight: 900;
      font-family: 'Orbitron', sans-serif;
      text-shadow: 0 0 20px rgba(138, 43, 226, 0.7);
      border-bottom: 1px solid rgba(138, 43, 226, 0.3);
      backdrop-filter: blur(10px);
      position: relative;
      z-index: 10;
    }
    
    .container {
      display: flex;
      flex: 1;
      gap: 30px;
      padding: 30px;
      max-width: 1400px;
      margin: 0 auto;
      width: 100%;
      position: relative;
      z-index: 2;
    }
    
    .panel {
      flex: 1;
      background: var(--card-bg);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 
        0 10px 30px rgba(0, 0, 0, 0.5),
        inset 0 0 30px rgba(77, 0, 255, 0.1);
      display: flex;
      flex-direction: column;
      border: 1px solid var(--card-border);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }
    
    .panel:hover {
      box-shadow: 
        0 15px 35px rgba(0, 0, 0, 0.6),
        inset 0 0 40px rgba(77, 0, 255, 0.15);
      transform: translateY(-5px);
    }
    
    .panel h2 {
      color: transparent;
      background-clip: text;
      -webkit-background-clip: text;
      background-image: linear-gradient(135deg, var(--primary) 0%, var(--neon-blue) 100%);
      margin-bottom: 25px;
      font-size: 2rem;
      font-family: 'Orbitron', sans-serif;
      font-weight: 700;
      text-align: center;
      border-bottom: 2px solid var(--primary);
      padding-bottom: 15px;
      text-shadow: 0 0 15px rgba(77, 0, 255, 0.5);
    }
    
    .post-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    label {
      color: var(--primary);
      font-weight: bold;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    input, textarea, select {
      padding: 14px 18px;
      border-radius: 12px;
      border: 1px solid rgba(138, 43, 226, 0.4);
      background: rgba(255, 255, 255, 0.08);
      color: var(--text-primary);
      font-size: 1rem;
      transition: all 0.3s ease;
      font-family: 'Montserrat', sans-serif;
    }
    
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 15px rgba(77, 0, 255, 0.5);
      background: rgba(255, 255, 255, 0.12);
    }
    
    textarea {
      min-height: 150px;
      resize: vertical;
    }
    
    .platform-info {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 20px;
      background: rgba(138, 43, 226, 0.1);
      border-radius: 15px;
      border: 1px solid var(--primary);
      transition: all 0.3s ease;
    }
    
    .platform-info:hover {
      background: rgba(138, 43, 226, 0.15);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(77, 0, 255, 0.3);
    }
    
    .platform-icon {
      font-size: 3.5rem;
      color: var(--primary);
      filter: drop-shadow(0 0 10px var(--primary));
    }
    
    .platform-details {
      flex: 1;
    }
    
    .platform-name {
      font-size: 1.6rem;
      font-weight: bold;
      color: var(--primary);
      margin-bottom: 8px;
      font-family: 'Orbitron', sans-serif;
    }
    
    .platform-status {
      color: #4caf50;
      font-size: 1rem;
      font-weight: bold;
    }
    
    .url-input-group {
      display: flex;
      gap: 12px;
    }
    
    .url-input-group input {
      flex: 1;
    }
    
    .preview-container {
      margin-top: 20px;
      text-align: center;
    }
    
    .preview-image {
      max-width: 100%;
      max-height: 220px;
      border-radius: 12px;
      display: none;
      border: 2px solid var(--primary);
      margin: 0 auto;
      box-shadow: 0 5px 15px rgba(77, 0, 255, 0.3);
    }
    
    .button-group {
      display: flex;
      gap: 15px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    
    button {
      flex: 1;
      padding: 16px 20px;
      border: none;
      border-radius: 12px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      position: relative;
      overflow: hidden;
      min-width: 220px;
      font-family: 'Montserrat', sans-serif;
    }
    
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 50%, var(--accent) 100%);
      color: var(--text-primary);
      box-shadow: 0 8px 20px rgba(77, 0, 255, 0.4);
    }
    
    .btn-primary::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }
    
    .btn-primary:hover:not(:disabled) {
      background: linear-gradient(135deg, var(--primary-light) 0%, var(--accent) 100%);
      transform: translateY(-5px);
      box-shadow: 0 12px 25px rgba(77, 0, 255, 0.6);
    }
    
    .btn-primary:hover:not(:disabled)::before {
      left: 100%;
    }
    
    .btn-primary:active:not(:disabled) {
      transform: translateY(-2px);
    }
    
    .btn-secondary {
      background: rgba(138, 43, 226, 0.2);
      color: var(--text-primary);
      border: 2px solid var(--primary);
      box-shadow: 0 8px 20px rgba(77, 0, 255, 0.2);
    }
    
    .btn-secondary:hover:not(:disabled) {
      background: rgba(138, 43, 226, 0.3);
      transform: translateY(-5px);
      box-shadow: 0 12px 25px rgba(77, 0, 255, 0.4);
    }
    
    .btn-secondary:active:not(:disabled) {
      transform: translateY(-2px);
    }
    
    .status-message {
      padding: 16px;
      border-radius: 12px;
      margin: 15px 0;
      text-align: center;
      font-weight: bold;
      display: none;
      animation: fadeIn 0.3s ease;
      font-size: 1.1rem;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .success {
      background: rgba(76, 175, 80, 0.2);
      color: #4caf50;
      border: 1px solid #4caf50;
      box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
    }
    
    .error {
      background: rgba(244, 67, 54, 0.2);
      color: #f44336;
      border: 1px solid #f44336;
      box-shadow: 0 5px 15px rgba(244, 67, 54, 0.3);
    }
    
    .button-loading {
      position: relative;
      color: transparent !important;
    }
    
    .button-loading::after {
      content: '';
      position: absolute;
      width: 22px;
      height: 22px;
      border: 2px solid transparent;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .schedule-options {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .schedule-toggle {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 65px;
      height: 36px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(26, 15, 56, 0.8);
      border: 2px solid var(--primary);
      transition: .4s;
      border-radius: 36px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 28px;
      width: 28px;
      left: 2px;
      bottom: 2px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      transition: .4s;
      border-radius: 50%;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    }
    
    input:checked + .toggle-slider {
      background-color: rgba(138, 43, 226, 0.2);
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(29px);
    }
    
    .datetime-input {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    
    .datetime-input.active {
      display: flex;
    }
    
    .history-item {
      background: rgba(138, 43, 226, 0.1);
      border-radius: 12px;
      padding: 18px;
      margin-bottom: 12px;
      border: 1px solid var(--primary);
      transition: all 0.3s ease;
    }
    
    .history-item:hover {
      background: rgba(138, 43, 226, 0.15);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(77, 0, 255, 0.2);
    }
    
    .history-text {
      margin-bottom: 12px;
      line-height: 1.5;
      color: var(--text-primary);
    }
    
    .history-meta {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }
    
    .history-status {
      color: #4caf50;
      font-weight: bold;
    }
    
    .api-status {
      margin-top: 12px;
      padding: 12px;
      border-radius: 10px;
      text-align: center;
      font-size: 1rem;
      font-weight: bold;
    }
    
    .api-status.connected {
      background: rgba(76, 175, 80, 0.2);
      color: #4caf50;
      border: 1px solid #4caf50;
      box-shadow: 0 3px 10px rgba(76, 175, 80, 0.2);
    }
    
    .api-status.error {
      background: rgba(244, 67, 54, 0.2);
      color: #f44336;
      border: 1px solid #f44336;
      box-shadow: 0 3px 10px rgba(244, 67, 54, 0.2);
    }
    
    .test-buttons {
      display: flex;
      gap: 12px;
      margin-top: 15px;
    }
    
    .test-btn {
      padding: 10px 18px;
      background: rgba(138, 43, 226, 0.2);
      border: 1px solid var(--primary);
      color: var(--text-primary);
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      font-family: 'Montserrat', sans-serif;
      font-weight: bold;
    }
    
    .test-btn:hover {
      background: rgba(138, 43, 226, 0.3);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(77, 0, 255, 0.3);
    }
    
    .debug-info {
      background: rgba(138, 43, 226, 0.1);
      padding: 15px;
      border-radius: 12px;
      margin-top: 15px;
      font-size: 0.9rem;
      color: var(--text-secondary);
      border: 1px solid var(--primary);
    }
    
    .local-history {
      max-height: 450px;
      overflow-y: auto;
    }
    
    .photo-attachment {
      background: rgba(138, 43, 226, 0.1);
      padding: 20px;
      border-radius: 15px;
      margin-top: 15px;
      border: 1px solid var(--primary);
    }
    
    .photo-inputs {
      display: flex;
      gap: 12px;
      margin-top: 15px;
    }
    
    .char-counter {
      text-align: right;
      margin-top: 8px;
      color: var(--text-secondary);
      font-size: 1rem;
    }
    
    .photo-preview {
      margin-top: 15px;
      text-align: center;
    }
    
    .extracted-info {
      background: rgba(76, 175, 80, 0.1);
      padding: 15px;
      border-radius: 12px;
      margin-top: 15px;
      border: 1px solid #4caf50;
      font-size: 1rem;
      color: #4caf50;
      font-weight: bold;
      display: none;
    }
    
    .form-control {
      padding: 14px 18px;
      border-radius: 12px;
      border: 1px solid rgba(138, 43, 226, 0.4);
      background: rgba(255, 255, 255, 0.08);
      color: var(--text-primary);
      font-size: 1rem;
      transition: all 0.3s ease;
      font-family: 'Montserrat', sans-serif;
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 15px rgba(77, 0, 255, 0.5);
      background: rgba(255, 255, 255, 0.12);
    }

    /* Водяной знак */
    .watermark {
      position: fixed;
      top: 50%;
      left: 50%;
      width: 300px;
      height: 300px;
      transform: translate(-50%, -50%);
      opacity: 0.03;
      pointer-events: none;
      user-select: none;
      z-index: 1;
      background: url('https://img.icons8.com/?size=100&id=gmWPXKWPTf64&format=png&color=000000') no-repeat center center;
      background-size: contain;
      animation: watermarkPulse 8s ease-in-out infinite alternate;
      filter: brightness(2);
    }
    
    @keyframes watermarkPulse {
      0% {
        opacity: 0.02;
        transform: translate(-50%, -50%) scale(1) rotate(0deg);
      }
      50% {
        opacity: 0.05;
        transform: translate(-50%, -50%) scale(1.05) rotate(2deg);
      }
      100% {
        opacity: 0.02;
        transform: translate(-50%, -50%) scale(1) rotate(0deg);
      }
    }

    /* Адаптивность для мобильных устройств */
    @media (max-width: 768px) {
      nav {
        flex-direction: column;
        gap: 12px;
        padding: 15px;
      }
      
      nav a {
        justify-content: center;
        padding: 10px 20px;
      }
      
      .container {
        flex-direction: column;
        padding: 20px;
        gap: 20px;
      }
      
      .button-group {
        flex-direction: column;
      }
      
      button {
        min-width: auto;
      }
      
      header {
        font-size: 2rem;
        padding: 20px;
      }
      
      .platform-info {
        flex-direction: column;
        text-align: center;
        gap: 15px;
      }
      
      .photo-inputs {
        flex-direction: column;
      }
      
      .test-buttons {
        flex-direction: column;
      }
    }
    
    @media (max-width: 480px) {
      nav {
        gap: 8px;
      }
      
      nav a {
        font-size: 1rem;
        padding: 8px 16px;
      }
      
      header {
        font-size: 1.8rem;
      }
      
      .panel {
        padding: 20px;
      }
      
      .panel h2 {
        font-size: 1.6rem;
      }
    }
  </style>
</head>
<body>
  <!-- Частицы фона -->
  <div class="particles" id="particles"></div>
  
  <!-- Водяной знак -->
  <div class="watermark" aria-hidden="true"></div>

  <!-- Навигационная панель -->
  <nav>
    <a href="index.html"><i class="fas fa-cube"></i> Мои предметы</a>
    <a href="index.html"><i class="fas fa-exchange-alt"></i> Предметы для обмена</a>
    <a href="index.html"><i class="fas fa-address-book"></i> Контакты</a>
    <a href="vk.html"><i class="fab fa-vk"></i> Посты в ВК</a>
    
  </nav>

  <header>
    <i class="fas fa-share-alt"></i> Публикация в ВКонтакте
  </header>
  
  <div class="container">
    <div class="panel">
      <h2>Создание поста</h2>
      <form class="post-form" id="postForm">
        <div class="form-group">
          <div class="platform-info">
            <i class="fab fa-vk platform-icon"></i>
            <div class="platform-details">
              <div class="platform-name">ВКонтакте</div>
              <div class="platform-status">✓ Подключено к группе ID: 233256913</div>
              <div id="apiStatus" class="api-status">
                <i class="fas fa-sync fa-spin"></i> Проверка подключения...
              </div>
              <div class="test-buttons">
                <button type="button" class="test-btn" onclick="testConnection()">Тест подключения</button>
                <button type="button" class="test-btn" onclick="testPostPublishing()">Тест публикации</button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label for="postText"><i class="fas fa-edit"></i> Текст поста</label>
          <textarea id="postText" placeholder="Введите текст для публикации в ВКонтакте..." maxlength="4000"></textarea>
          <div class="char-counter">
            <span id="charCount">0</span>/4000 символов
          </div>
        </div>

        <div class="form-group">
          <label><i class="fas fa-image"></i> Прикрепление фото из ВКонтакте</label>
          <div class="photo-attachment">
            <p><strong>Вставьте ссылку на фото из ВКонтакте:</strong></p>
            <div class="photo-inputs">
              <input type="url" id="photoUrl" placeholder="https://vk.com/photo123456789_456239021" class="form-control">
              <button type="button" class="btn-secondary" id="parseUrlBtn">
                <i class="fas fa-link"></i> Извлечь ID
              </button>
            </div>
            <div id="extractedInfo" class="extracted-info" style="display: none;">
              <i class="fas fa-check-circle"></i> ID извлечены: <span id="photoIds"></span>
            </div>
            <div class="photo-preview">
              <img id="previewImage" class="preview-image" src="" alt="Предпросмотр изображения">
            </div>
            <small style="color: var(--text-secondary); margin-top: 8px; display: block;">
              Поддерживаются ссылки на фото из ВКонтакте
            </small>
          </div>
        </div>

        <div class="form-group">
          <label><i class="fas fa-clock"></i> Настройки публикации</label>
          <div class="schedule-options">
            <div class="schedule-toggle">
              <label class="toggle-switch">
                <input type="checkbox" id="scheduleToggle">
                <span class="toggle-slider"></span>
              </label>
              <span>Отложенная публикация</span>
            </div>
            
            <div class="datetime-input" id="datetimeInput">
              <input type="datetime-local" id="scheduleDateTime">
            </div>
          </div>
        </div>

        <div class="form-group">
          <div class="schedule-toggle">
            <label class="toggle-switch">
              <input type="checkbox" id="fromGroup" checked>
              <span class="toggle-slider"></span>
            </label>
            <span>Опубликовать от имени сообщества</span>
          </div>
          <div class="schedule-toggle">
            <label class="toggle-switch">
              <input type="checkbox" id="signed" checked>
              <span class="toggle-slider"></span>
            </label>
            <span>Подписать автора (администратора)</span>
          </div>
        </div>
        
        <div class="button-group">
          <button type="button" class="btn-primary" id="publishBtn">
            <i class="fas fa-paper-plane"></i> Опубликовать в ВК
          </button>
          <button type="button" class="btn-secondary" id="previewBtn">
            <i class="fas fa-eye"></i> Предпросмотр
          </button>
        </div>
        
        <div class="status-message success" id="successMessage">
          <i class="fas fa-check-circle"></i> Пост успешно опубликован в ВКонтакте!
        </div>
        
        <div class="status-message error" id="errorMessage">
          <i class="fas fa-exclamation-triangle"></i> Произошла ошибка при публикации
        </div>

        <div class="debug-info" id="debugInfo">
          Режим отладки: информация о запросах будет отображаться здесь
        </div>
      </form>
    </div>
    
    <div class="panel">
      <h2>История публикаций</h2>
      <div class="form-group">
        <input type="text" id="searchHistory" placeholder="Поиск по истории..." class="form-control">
      </div>
      <div class="local-history">
        <div id="historyList">
          <div class="history-item">
            <div class="history-text">Здесь будет отображаться история ваших постов</div>
            <div class="history-meta">
              <span>--.--.---- --:--</span>
              <span class="history-status">Готов</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Функция для создания частиц
    function createParticles() {
      const particlesContainer = document.getElementById('particles');
      const particleCount = 25;
      
      for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        
        // Случайные начальные позиции
        const left = Math.random() * 100;
        const size = Math.random() * 3 + 1;
        const opacity = Math.random() * 0.5 + 0.2;
        const animationDuration = Math.random() * 20 + 10;
        const animationDelay = Math.random() * 5;
        
        particle.style.left = `${left}%`;
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        particle.style.opacity = opacity;
        particle.style.animationDuration = `${animationDuration}s`;
        particle.style.animationDelay = `${animationDelay}s`;
        
        particlesContainer.appendChild(particle);
      }
    }

    const VK_TOKEN = 'vk1.a.7uJ7G6fmHIYr8WGbLxDwJihIVjf1cF6HAIJ0WiCB9BpphP57D09rQhsu2lpOWT8dDjOuQldkbye8UyhtBK764iHAbrMy5zipVhBmrlJW-q45e1htB4sxiAtMWa9QpssoffYG8k6YolcvLogAMIykahh5IHc7pBvf7KJSr12EO_rM1TWiHWdm9WGk7bYKK3cAQEzzIKcVY86iD2MIqKRIRQ';
    const GROUP_ID = '-233612410';
    let localHistory = JSON.parse(localStorage.getItem('vk_publish_history') || '[]');
    let extractedPhotoIds = [];

    // Инициализация
    document.addEventListener('DOMContentLoaded', function() {
      createParticles();
      initializeScheduleToggle();
      checkTokenValidity();
      loadLocalHistory();
      setupCharCounter();
      setupUrlParser();
      
      // Загружаем черновик если есть
      const savedDraft = localStorage.getItem('vk_draft');
      if (savedDraft) {
        document.getElementById('postText').value = savedDraft;
        document.getElementById('charCount').textContent = savedDraft.length;
      }
    });

    // Счетчик символов
    function setupCharCounter() {
      const postText = document.getElementById('postText');
      const charCount = document.getElementById('charCount');
      
      postText.addEventListener('input', function() {
        charCount.textContent = this.value.length;
      });
    }

    // Парсер ссылок ВК
    function setupUrlParser() {
      const parseBtn = document.getElementById('parseUrlBtn');
      const photoUrl = document.getElementById('photoUrl');
      
      parseBtn.addEventListener('click', function() {
        const url = photoUrl.value.trim();
        if (!url) {
          showMessage('Введите ссылку на фото', 'error');
          return;
        }
        
        const photoIds = extractPhotoIdsFromUrl(url);
        if (photoIds.length > 0) {
          extractedPhotoIds = photoIds;
          displayExtractedIds(photoIds);
          showMessage(`Успешно извлечено ${photoIds.length} ID фото`, 'success');
          loadPhotoPreview(photoIds[0]);
        } else {
          showMessage('Не удалось извлечь ID фото из ссылки', 'error');
        }
      });
      
      // Автоматический парсинг при вставке
      photoUrl.addEventListener('paste', function(e) {
        setTimeout(() => {
          const url = photoUrl.value.trim();
          const photoIds = extractPhotoIdsFromUrl(url);
          if (photoIds.length > 0) {
            extractedPhotoIds = photoIds;
            displayExtractedIds(photoIds);
            loadPhotoPreview(photoIds[0]);
          }
        }, 100);
      });
    }

    // Извлечение ID фото из различных форматов ссылок ВК
    function extractPhotoIdsFromUrl(url) {
      const patterns = [
        // photo123456789_456239021
        /photo(-?\d+)_(\d+)/,
        // https://vk.com/photo123456789_456239021
        /vk\.com\/photo(-?\d+)_(\d+)/,
        // https://vk.com/wall123456789?z=photo123456789_456239021
        /z=photo(-?\d+)_(\d+)/,
        // albums123456789/456239021
        /albums(-?\d+)\/(\d+)/,
        // photos123456789/456239021
        /photos(-?\d+)\/(\d+)/
      ];
      
      const photoIds = [];
      
      for (const pattern of patterns) {
        const match = url.match(pattern);
        if (match) {
          const ownerId = match[1];
          const photoId = match[2];
          photoIds.push(`${ownerId}_${photoId}`);
        }
      }
      
      return photoIds;
    }

    // Отображение извлеченных ID
    function displayExtractedIds(photoIds) {
      const extractedInfo = document.getElementById('extractedInfo');
      const photoIdsSpan = document.getElementById('photoIds');
      
      photoIdsSpan.textContent = photoIds.map(id => `photo${id}`).join(', ');
      extractedInfo.style.display = 'block';
    }

    // Загрузка превью фото
    function loadPhotoPreview(photoId) {
      const previewImage = document.getElementById('previewImage');
      
      // Пробуем разные варианты URL для превью
      const previewUrls = [
        `https://sun9-71.userapi.com/impg/${photoId.replace('_', '/')}.jpg`,
        `https://sun1-87.userapi.com/impg/${photoId.replace('_', '/')}.jpg`,
        `https://sun9-74.userapi.com/impg/${photoId.replace('_', '/')}.jpg`
      ];
      
      let currentUrlIndex = 0;
      
      function tryNextUrl() {
        if (currentUrlIndex >= previewUrls.length) {
          previewImage.style.display = 'none';
          return;
        }
        
        previewImage.src = previewUrls[currentUrlIndex];
        previewImage.style.display = 'block';
        
        previewImage.onload = function() {
          // Фото загружено успешно
        };
        
        previewImage.onerror = function() {
          currentUrlIndex++;
          tryNextUrl();
        };
      }
      
      tryNextUrl();
    }

    // Инициализация переключателя расписания
    function initializeScheduleToggle() {
      const scheduleToggle = document.getElementById('scheduleToggle');
      const datetimeInput = document.getElementById('datetimeInput');
      
      if (scheduleToggle && datetimeInput) {
        scheduleToggle.addEventListener('change', function() {
          if (this.checked) {
            datetimeInput.classList.add('active');
            const minDate = new Date(Date.now() + 5 * 60 * 1000);
            document.getElementById('scheduleDateTime').min = minDate.toISOString().slice(0, 16);
            const defaultDate = new Date(Date.now() + 60 * 60 * 1000);
            document.getElementById('scheduleDateTime').value = defaultDate.toISOString().slice(0, 16);
          } else {
            datetimeInput.classList.remove('active');
          }
        });
      }
    }

    // JSONP функция для обхода CORS
    function callVKAPI(method, params = {}) {
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
        const script = document.createElement('script');
        
        const baseParams = {
          access_token: VK_TOKEN,
          v: '5.199'
        };
        
        const allParams = { ...baseParams, ...params };
        allParams.callback = callbackName;
        
        const paramString = Object.keys(allParams)
          .map(key => `${encodeURIComponent(key)}=${encodeURIComponent(allParams[key])}`)
          .join('&');
        
        const url = `https://api.vk.com/method/${method}?${paramString}`;
        
        updateDebugInfo(`Отправка запроса: ${method}`);
        
        window[callbackName] = function(data) {
          delete window[callbackName];
          document.body.removeChild(script);
          
          if (data.error) {
            updateDebugInfo(`Ошибка API: ${data.error.error_msg}`);
            reject(new Error(`VK API: ${data.error.error_msg} (код: ${data.error.error_code})`));
          } else {
            updateDebugInfo(`Успешный ответ: ${method}`);
            resolve(data.response);
          }
        };
        
        script.onerror = function() {
          delete window[callbackName];
          document.body.removeChild(script);
          updateDebugInfo('Ошибка загрузки скрипта');
          reject(new Error('Ошибка загрузки скрипта VK API'));
        };
        
        script.src = url;
        document.body.appendChild(script);
      });
    }

    // Тест подключения
    async function testConnection() {
      try {
        showMessage('Тестирование подключения...', 'success');
        const result = await callVKAPI('wall.post', {
          owner_id: GROUP_ID,
          message: 'Тестовый пост - проверка подключения',
          publish_date: Math.floor(Date.now() / 1000) + 300
        });
        showMessage('✓ Подключение успешно! Можно публиковать посты', 'success');
      } catch (error) {
        if (error.message.includes('wall.post')) {
          showMessage('✓ Подключение работает! Ошибка ожидаема для тестового поста', 'success');
        } else {
          showMessage('✗ Ошибка подключения: ' + error.message, 'error');
        }
      }
    }

    // Тест публикации
    async function testPostPublishing() {
      try {
        showMessage('Тест публикации...', 'success');
        const result = await callVKAPI('wall.post', {
          owner_id: GROUP_ID,
          message: 'Тестовый пост от ' + new Date().toLocaleString('ru-RU'),
          from_group: 1,
          signed: 1
        });
        showMessage('✓ Тест успешен! Пост опубликован с ID: ' + result.post_id, 'success');
        addToLocalHistory('Тестовый пост', result.post_id, true);
      } catch (error) {
        showMessage('✗ Ошибка теста: ' + error.message, 'error');
      }
    }

    async function checkTokenValidity() {
      try {
        await callVKAPI('wall.post', {
          owner_id: GROUP_ID,
          message: 'test',
          publish_date: Math.floor(Date.now() / 1000) + 3600
        });
        
        document.getElementById('apiStatus').className = 'api-status connected';
        document.getElementById('apiStatus').innerHTML = 
          `<i class="fas fa-check-circle"></i> Токен валиден, можно публиковать посты`;
          
      } catch (error) {
        if (error.message.includes('wall.post')) {
          document.getElementById('apiStatus').className = 'api-status connected';
          document.getElementById('apiStatus').innerHTML = 
            `<i class="fas fa-check-circle"></i> Подключение активно (ошибка в тестовом посте ожидаема)`;
        } else {
          document.getElementById('apiStatus').className = 'api-status error';
          document.getElementById('apiStatus').innerHTML = 
            `<i class="fas fa-exclamation-triangle"></i> Ошибка: ${error.message}`;
        }
      }
    }

    // Публикация поста
    document.getElementById('publishBtn').addEventListener('click', async function() {
      const postText = document.getElementById('postText').value.trim();
      const publishBtn = this;
      
      if (!postText) {
        showMessage('Введите текст поста', 'error');
        return;
      }
      
      publishBtn.classList.add('button-loading');
      publishBtn.disabled = true;
      
      try {
        // Параметры для публикации
        const params = {
          owner_id: GROUP_ID,
          message: postText,
          from_group: document.getElementById('fromGroup').checked ? 1 : 0,
          signed: document.getElementById('signed').checked ? 1 : 0
        };
        
        // Добавляем фото если есть извлеченные ID
        if (extractedPhotoIds.length > 0) {
          const attachments = extractedPhotoIds.map(id => `photo${id}`).join(',');
          params.attachments = attachments;
          updateDebugInfo(`Прикрепляемые фото: ${attachments}`);
        }
        
        // Отложенная публикация
        const scheduleToggle = document.getElementById('scheduleToggle');
        if (scheduleToggle && scheduleToggle.checked) {
          const dateTimeInput = document.getElementById('scheduleDateTime');
          if (dateTimeInput && dateTimeInput.value) {
            const dateTime = new Date(dateTimeInput.value);
            if (dateTime > new Date()) {
              params.publish_date = Math.floor(dateTime.getTime() / 1000);
              updateDebugInfo(`Отложенная публикация: ${dateTime.toLocaleString('ru-RU')}`);
            }
          }
        }
        
        updateDebugInfo(`Публикация поста: ${postText.substring(0, 50)}...`);
        
        // Публикуем пост
        const result = await callVKAPI('wall.post', params);
        
        let successMsg = '✓ Пост успешно опубликован в ВКонтакте! ID: ' + result.post_id;
        if (extractedPhotoIds.length > 0) {
          successMsg += ` с ${extractedPhotoIds.length} фото`;
        }
        showMessage(successMsg, 'success');
        updateDebugInfo(`Пост опубликован с ID: ${result.post_id}`);
        
        // Добавляем в локальную историю
        addToLocalHistory(postText, result.post_id, true);
        
        // Очищаем форму
        resetForm();
        
      } catch (error) {
        const errorMsg = '✗ Ошибка публикации: ' + error.message;
        showMessage(errorMsg, 'error');
        updateDebugInfo(errorMsg);
        
        addToLocalHistory(postText, 'error', false);
        
        console.error('Publish error:', error);
      } finally {
        publishBtn.classList.remove('button-loading');
        publishBtn.disabled = false;
      }
    });

    // Предпросмотр
    document.getElementById('previewBtn').addEventListener('click', function() {
      const postText = document.getElementById('postText').value.trim();
      if (!postText) {
        showMessage('Введите текст поста для предпросмотра', 'error');
        return;
      }
      
      localStorage.setItem('vk_draft', postText);
      
      let previewInfo = 'Текст поста готов к публикации. ';
      if (extractedPhotoIds.length > 0) {
        previewInfo += `Будет прикреплено ${extractedPhotoIds.length} фото`;
      } else {
        previewInfo += 'Фото не прикреплены.';
      }
      
      showMessage(previewInfo, 'success');
    });

    // Локальная история в браузере
    function addToLocalHistory(text, postId, success) {
      const historyItem = {
        id: Date.now(),
        text: text,
        postId: postId,
        success: success,
        timestamp: new Date().toISOString(),
        date: new Date().toLocaleString('ru-RU')
      };
      
      localHistory.unshift(historyItem);
      localHistory = localHistory.slice(0, 50);
      localStorage.setItem('vk_publish_history', JSON.stringify(localHistory));
      
      loadLocalHistory();
    }

    function loadLocalHistory() {
      const historyList = document.getElementById('historyList');
      historyList.innerHTML = '';
      
      if (localHistory.length === 0) {
        historyList.innerHTML = `
          <div class="history-item">
            <div class="history-text">История публикаций пуста</div>
            <div class="history-meta">
              <span>--.--.---- --:--</span>
              <span class="history-status">Нет данных</span>
            </div>
          </div>
        `;
        return;
      }
      
      localHistory.forEach(item => {
        const shortText = item.text.length > 100 ? item.text.substring(0, 100) + '...' : item.text;
        const status = item.success ? '✅ Успешно' : '❌ Ошибка';
        const statusColor = item.success ? '#4caf50' : '#f44336';
        
        const historyItem = document.createElement('div');
        historyItem.className = 'history-item';
        historyItem.innerHTML = `
          <div class="history-text">${shortText}</div>
          <div class="history-meta">
            <span>${item.date}</span>
            <span class="history-status" style="color: ${statusColor};">${status}</span>
          </div>
          ${item.postId && item.postId !== 'error' ? 
            `<div style="font-size: 0.7rem; color: var(--text-secondary);">ID поста: ${item.postId}</div>` : ''}
        `;
        historyList.appendChild(historyItem);
      });
    }

    // Сброс формы
    function resetForm() {
      document.getElementById('postText').value = '';
      document.getElementById('photoUrl').value = '';
      document.getElementById('charCount').textContent = '0';
      document.getElementById('scheduleToggle').checked = false;
      document.getElementById('datetimeInput').classList.remove('active');
      document.getElementById('extractedInfo').style.display = 'none';
      document.getElementById('previewImage').style.display = 'none';
      extractedPhotoIds = [];
      localStorage.removeItem('vk_draft');
    }

    // Показать сообщение
    function showMessage(text, type) {
      const messageEl = type === 'success' ? 
        document.getElementById('successMessage') : 
        document.getElementById('errorMessage');
      
      messageEl.innerHTML = type === 'success' ? 
        `<i class="fas fa-check-circle"></i> ${text}` :
        `<i class="fas fa-exclamation-triangle"></i> ${text}`;
      
      messageEl.style.display = 'block';
      
      const otherMessageEl = type === 'success' ? 
        document.getElementById('errorMessage') : 
        document.getElementById('successMessage');
      otherMessageEl.style.display = 'none';
      
      setTimeout(() => {
        messageEl.style.display = 'none';
      }, 5000);
    }

    // Обновление отладочной информации
    function updateDebugInfo(message) {
      const debugEl = document.getElementById('debugInfo');
      const timestamp = new Date().toLocaleTimeString();
      debugEl.innerHTML = `<strong>${timestamp}:</strong> ${message}`;
    }

    // Поиск по истории
    document.getElementById('searchHistory').addEventListener('input', function(e) {
      const searchTerm = e.target.value.toLowerCase();
      const historyItems = document.querySelectorAll('.history-item');
      
      historyItems.forEach(item => {
        const text = item.querySelector('.history-text').textContent.toLowerCase();
        if (text.includes(searchTerm)) {
          item.style.display = 'block';
        } else {
          item.style.display = 'none';
        }
      });
    });
  </script>
</body>
</html>